{% extends "layout.html" %}

{% block body %}

<div class="row justify-content-around">
  <div class="col-3 col-ingredient">
    <h3>{{ recipe.name }}</h3>
    {% if current_user.is_authenticated and recipe.account_id == account_id %}
    <p class="card-text"><small class="text-muted">
        <a href="{{ url_for('recipes_edit', recipe_id=recipe.id) }}">Edit</a>
        &emsp;
        <a href="{{ url_for('recipes_delete', recipe_id=recipe.id) }}">Delete </a></p>
    </small>
    {% endif %}
    <p>
      <font size="2">{{ recipe.date_created.strftime('%Y-%m-%d %H:%M:%S') }}</font>
    </p>
    <p>Servings:
      <input type="number" min="1" , value="{{ recipe.servings }}" style="max-width: 4em;" id="servings_counter">
    </p>
    <small class="text-muted">
      <p>
        Calories per serving: {{ (kcal_total|string).rstrip('0').rstrip('.') }} kcal
      </p>
      {% if missing %}
      <p>
        (calorie data missing for:
        {% for missing in missing %}
        {{ missing }}{{", " if not loop.last }}{% endfor %})
      </p>
      {% endif %}

    </small>
    <table style="margin-top: 30px;">
      {% for ingredient in ingredients %}
      <tr class="ingredient_row">
        <td>
          <input type="hidden" id="amount_value" value="{{ ingredient['amount'] }}">
          <input type="hidden" id="unit_value" value="{{ ingredient['unit'] }}">
          <input type="hidden" id="name_value" value="{{ ingredient['name'] }}">
        </td>
        <td id="ingredient_text">{{ (ingredient['amount']|string).rstrip('0').rstrip('.') }} {{ ingredient['unit'] }}
          {{ ingredient['name'] }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  <div class=" col-8 col-instructions">
    <p class="p-instructions">{{ recipe.instructions }}</p>
  </div>
</div>

<script type="text/javascript">

  //Adjust ingredient amounts when amount of servings is changed
  $(document).ready(function () {

    var counter = $("#servings_counter");
    var previousServings = counter.val();

    $("#servings_counter").on("input", function () {
      var currentServings = counter.val();

      $('.ingredient_row').each(function () {
        let store = $(this).find("#amount_value");

        let newAmount = store.val() / previousServings * currentServings;
        let newText = newAmount.toString() + ' ' + $(this).find("#unit_value").val() + ' ' + $(this).find("#name_value").val();

        $(this).find("#ingredient_text").text(newText);

        store.val(newAmount);
      });
      previousServings = currentServings;
    });
  });

</script>

{% endblock %}